name: Continuous Deployment

on:
  push:
    tags:
      - "*-v*.*.*"

jobs:
  changelog:
    name: ðŸ“ Generate changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      brick_name: ${{ steps.extract.outputs.brick_name }}
      release_body: ${{ steps.git-cliff.outputs.content }}
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract brick name and version
        id: extract
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BRICK_NAME=${TAG_NAME%-v*}
          VERSION=${TAG_NAME#*-v}
          echo "brick_name=$BRICK_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: ðŸ“ Generate changelog for brick
        uses: orhun/git-cliff-action@v4
        id: git-cliff
        with:
          config: cliff.toml
          args: --verbose --latest --strip header --prepend ${{ steps.extract.outputs.brick_name }}/CHANGELOG.md --include-path ${{ steps.extract.outputs.brick_name }}/**
        env:
          OUTPUT: ${{ steps.extract.outputs.brick_name }}/CHANGELOG.md
          GITHUB_REPO: ${{ github.repository }}

      - name: ðŸ’¾ Commit and push changelog
        run: |
          git checkout main
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          set +e
          git add ${{ steps.extract.outputs.brick_name }}/CHANGELOG.md
          git commit -m "docs(${{ steps.extract.outputs.brick_name }}): update changelog for v${{ steps.extract.outputs.version }} [skip ci]"
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git main

  publish:
    name: ðŸš€ Publish brick
    uses: egortabula/egortabula_workflows/.github/workflows/mason_publish.yml@v1
    needs: changelog
    with:
      working_directory: ${{ needs.changelog.outputs.brick_name }}
    secrets:
      mason_credentials: ${{ secrets.MASON_CREDENTIALS }}

  release:
    name: ðŸŽ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [changelog, publish]
    permissions:
      contents: write
    steps:
      - name: ðŸ·ï¸ Extract brick name and version
        id: extract
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BRICK_NAME=${TAG_NAME%-v*}
          VERSION=${TAG_NAME#*-v}
          echo "brick_name=$BRICK_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: ðŸŽ‰ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract.outputs.tag_name }}
          release_name: "${{ steps.extract.outputs.brick_name }}-v${{ steps.extract.outputs.version }}"
          body: |
            # ðŸ§± ${{ steps.extract.outputs.brick_name }} v${{ steps.extract.outputs.version }}

            ## ðŸ“¦ What's Changed
            ${{ needs.changelog.outputs.release_body }}

            ## ðŸš€ Installation
            ```bash
            mason add ${{ steps.extract.outputs.brick_name }}
            ```

            ## ðŸ“š Documentation
            See the [README](${{ github.server_url }}/${{ github.repository }}/tree/${{ steps.extract.outputs.tag_name }}/${{ steps.extract.outputs.brick_name }}/README.md) for usage instructions.
          draft: false
          prerelease: false
