name: Continuous Deployment

on:
  push:
    tags:
      - "*-v*.*.*"

jobs:
  changelog:
    name: ðŸ“ Generate changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      brick_name: ${{ steps.extract.outputs.brick_name }}
      version: ${{ steps.extract.outputs.version }}
      release_body: ${{ steps.git-cliff.outputs.content }}
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract brick name and version
        id: extract
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BRICK_NAME=${TAG_NAME%-v*}
          VERSION=${TAG_NAME#*-v}
          echo "brick_name=$BRICK_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: ðŸ“ Generate changelog for brick
        uses: orhun/git-cliff-action@v4
        id: git-cliff
        with:
          config: cliff.toml
          args: --verbose --unreleased --tag ${{ steps.extract.outputs.tag_name }}--prepend ${{ steps.extract.outputs.brick_name }}/CHANGELOG.md --include-path ${{ steps.extract.outputs.brick_name }}/**
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_REPO: ${{ github.repository }}

      - name: ðŸ’¾ Commit and push changelog
        run: |
          git checkout main
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          set +e
          git add ${{ steps.extract.outputs.brick_name }}/CHANGELOG.md
          git commit -m "docs(${{ steps.extract.outputs.brick_name }}): update changelog for v${{ steps.extract.outputs.version }} [skip ci]"
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git main

  # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð² brick.yaml
  update_version:
    name: ðŸ”„ Update brick version
    runs-on: ubuntu-latest
    needs: changelog
    permissions:
      contents: write
    steps:
      - name: ï¿½ Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ï¿½ðŸ”„ Update brick.yaml version
        run: |
          cd ${{ needs.changelog.outputs.brick_name }}

          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² brick.yaml
          if [ -f "brick.yaml" ]; then
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ sed Ð´Ð»Ñ Ð·Ð°Ð¼ÐµÐ½Ñ‹ Ð²ÐµÑ€ÑÐ¸Ð¸
            sed -i.bak "s/^version: .*/version: ${{ needs.changelog.outputs.version }}/" brick.yaml
            rm brick.yaml.bak
            echo "âœ… Updated version in brick.yaml to ${{ needs.changelog.outputs.version }}"
          else
            echo "âš ï¸ brick.yaml not found in ${{ needs.changelog.outputs.brick_name }}"
          fi

      - name: ðŸ’¾ Commit and push version update
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          set +e
          git add ${{ needs.changelog.outputs.brick_name }}/brick.yaml
          git commit -m "chore(${{ needs.changelog.outputs.brick_name }}): bump version to v${{ needs.changelog.outputs.version }} [skip ci]"
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git main

  # ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð´Ð»Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
  sync:
    name: â³ Sync changes
    runs-on: ubuntu-latest
    needs: [changelog, update_version]
    steps:
      - name: â³ Wait for changes to propagate
        run: sleep 10

  publish:
    name: ðŸš€ Publish brick
    uses: egortabula/egortabula_workflows/.github/workflows/mason_publish.yml@v1
    needs: [changelog, update_version, sync]
    with:
      working_directory: ${{ needs.changelog.outputs.brick_name }}
    secrets:
      mason_credentials: ${{ secrets.MASON_CREDENTIALS }}

  release:
    name: ðŸŽ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [changelog, update_version, sync, publish]
    permissions:
      contents: write
    steps:
      - name: ðŸ·ï¸ Extract brick name and version
        id: extract
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          BRICK_NAME=${TAG_NAME%-v*}
          VERSION=${TAG_NAME#*-v}
          echo "brick_name=$BRICK_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: ðŸŽ‰ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract.outputs.tag_name }}
          release_name: "${{ steps.extract.outputs.brick_name }}-v${{ steps.extract.outputs.version }}"
          body: |
            # ðŸ§± ${{ steps.extract.outputs.brick_name }} v${{ steps.extract.outputs.version }}

            ## ðŸ“¦ What's Changed
            ${{ needs.changelog.outputs.release_body }}

            ## ðŸš€ Installation
            ```bash
            mason add ${{ steps.extract.outputs.brick_name }}
            ```

            ## ðŸ“š Documentation
            See the [README](${{ github.server_url }}/${{ github.repository }}/tree/${{ steps.extract.outputs.tag_name }}/${{ steps.extract.outputs.brick_name }}/README.md) for usage instructions.
          draft: false
          prerelease: false
